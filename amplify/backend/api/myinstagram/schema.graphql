# Re-syncing environment
# Removed global auth rule for more specific control
type User @model @auth(rules: [
  { allow: owner },
  { allow: private, operations: [read] }
]) {
  id: ID!
  username: String! @primaryKey
  preferred_username: String
  email: String!
  phone_number: String
  gender: String
  bio: String
  avatar: String
  accountType: String @default(value: "public") # public or private
  posts: [Post] @hasMany
  likes: [Like] @hasMany
  comments: [Comment] @hasMany
  following: [Follow] @hasMany(indexName: "byFollower", fields: ["username"])
  followers: [Follow] @hasMany(indexName: "byFollowed", fields: ["username"])
  notifications: [Notification] @hasMany(indexName: "byUser", fields: ["username"])
  messages: [Message] @hasMany(indexName: "bySender", fields: ["username"])
}

type Post @model @auth(rules: [
    { allow: owner },
    { allow: private, operations: [read] }
  ]) {
  id: ID!
  content: String!
  image: String
  video: String
  audio: String
  location: String
  tags: [String]
  hashtags: [String]
mentions: [String]
  userId: String! # Le username de l'utilisateur qui a créé le post
  user: User! @belongsTo(fields: ["userId"])
  likes: [Like] @hasMany
  comments: [Comment] @hasMany
  notifications: [Notification] @hasMany(indexName: "byPost", fields: ["id"])
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
  owner: String
}

type Like @model @auth(rules: [
    { allow: owner },
    { allow: private, operations: [read] }
  ]) {
  id: ID!
  postId: ID! @index
  userId: String! @index
  post: Post! @belongsTo(fields: ["postId"])
  user: User! @belongsTo(fields: ["userId"])
  createdAt: AWSDateTime!
  owner: String
}

type Comment @model @auth(rules: [
    { allow: owner },
    { allow: private, operations: [read] }
  ]) {
  id: ID!
  postId: ID! @index
  userId: String! @index
  content: String!
  post: Post! @belongsTo(fields: ["postId"])
  user: User! @belongsTo(fields: ["userId"])
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
  owner: String
}

type Follow @model @auth(rules: [
    { allow: owner },
    { allow: private, operations: [read] }
  ]) {
  id: ID!
  followerId: String! @index(name: "byFollower", sortKeyFields: ["followedId"])
  followedId: String! @index(name: "byFollowed", sortKeyFields: ["followerId"])
  follower: User! @belongsTo(fields: ["followerId"])
  followed: User! @belongsTo(fields: ["followedId"])
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
  owner: String
}

type Notification @model @auth(rules: [
  { allow: owner, ownerField: "userId", operations: [read, delete] }
]) {
  id: ID!
  userId: String! @index(name: "byUser", sortKeyFields: ["createdAt"])
  type: String! # NEW_LIKE, NEW_COMMENT, NEW_FOLLOWER
  actorId: String!
  actor: User @belongsTo(fields: ["actorId"])
  postId: ID @index(name: "byPost", sortKeyFields: ["createdAt"])
  post: Post @belongsTo(fields: ["postId"])
  read: Boolean! @default(value: "false")
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type Conversation @model @auth(rules: [
  { allow: owner, ownerField: "members" }
]) {
  id: ID!
  members: [String!]!
  messages: [Message] @hasMany(indexName: "byConversation", fields: ["id"])
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type Message @model @auth(rules: [
  { allow: owner, ownerField: "senderId" },
  { allow: private, operations: [read] }
]) {
  id: ID!
  conversationId: ID! @index(name: "byConversation", sortKeyFields: ["createdAt"])
  senderId: String! @index(name: "bySender", sortKeyFields: ["createdAt"])
  sender: User @belongsTo(fields: ["senderId"])
  content: String!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type Query {
  searchUsers(query: String!): [User] @function(name: "searchUsersFunction-${env}")
}
